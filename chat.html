<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Samia Chatbot: Your AI Girlfriend (Enhanced)</title>
    <link rel="icon" href="avatar.jpeg" type="image/jpeg">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        :root {
            /* Light mode variables */
            --background-light: #FFFFFF;
            --background-secondary-light: #F0F2F5;
            --user-bubble-gradient-light: linear-gradient(135deg, #0084FF, #0078FF, #006AFF);
            --bot-bubble-light: #E4E6EB; /* Slightly adjusted for better contrast */
            --text-primary-light: #050505;
            --text-secondary-light: #65676B;
            --text-on-accent-light: #FFFFFF;
            --accent-color: #007AFF;
            --accent-hover: #005ECC;
            --online-status: #31A24C;
            --input-bg-light: #F0F2F5;
            --input-border-light: #CED0D4;
            --button-secondary-bg-light: #E4E6EB;
            --button-secondary-text-light: #050505;
            --reaction-bg-light: rgba(255, 255, 255, 0.9);
            --reaction-bg-hover-light: rgba(240, 240, 240, 0.95);
            --emoji-picker-bg-light: #FFFFFF;
            --emoji-picker-border-light: #E0E0E0;
            --emoji-picker-shadow-light: 0 4px 12px rgba(0, 0, 0, 0.1);

            /* Dark mode variables */
            --background-dark: #18191A;
            --background-secondary-dark: #242526;
            --user-bubble-gradient-dark: linear-gradient(135deg, #0084FF, #0078FF, #006AFF);
            --bot-bubble-dark: #3A3B3C;
            --text-primary-dark: #E4E6EB;
            --text-secondary-dark: #B0B3B8;
            --text-on-accent-dark: #FFFFFF;
            --input-bg-dark: #3A3B3C;
            --input-border-dark: #4E4F50;
            --button-secondary-bg-dark: #4E4F50;
            --button-secondary-text-dark: #E4E6EB;
            --reaction-bg-dark: rgba(40, 40, 40, 0.9);
            --reaction-bg-hover-dark: rgba(50, 50, 50, 0.95);
            --emoji-picker-bg-dark: #2C2D2E;
            --emoji-picker-border-dark: #404040;
            --emoji-picker-shadow-dark: 0 4px 12px rgba(0, 0, 0, 0.3);

            /* Common variables */
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.1);
            --radius-sm: 8px;
            --radius-md: 18px;
            --radius-lg: 24px;
            --radius-full: 999px;
            --transition-fast: 0.15s ease-out;
            --transition-normal: 0.25s ease-out;
            --transition-smooth: 0.3s cubic-bezier(0.4, 0, 0.2, 1);

            /* Default to light mode */
            --background: var(--background-light);
            --background-secondary: var(--background-secondary-light);
            --user-bubble-gradient: var(--user-bubble-gradient-light);
            --bot-bubble: var(--bot-bubble-light);
            --text-primary: var(--text-primary-light);
            --text-secondary: var(--text-secondary-light);
            --text-on-accent: var(--text-on-accent-light);
            --input-bg: var(--input-bg-light);
            --input-border: var(--input-border-light);
            --button-secondary-bg: var(--button-secondary-bg-light);
            --button-secondary-text: var(--button-secondary-text-light);
            --reaction-bg: var(--reaction-bg-light);
            --reaction-bg-hover: var(--reaction-bg-hover-light);
            --emoji-picker-bg: var(--emoji-picker-bg-light);
            --emoji-picker-border: var(--emoji-picker-border-light);
            --emoji-picker-shadow: var(--emoji-picker-shadow-light);
        }

        .dark-mode {
            --background: var(--background-dark);
            --background-secondary: var(--background-secondary-dark);
            --user-bubble-gradient: var(--user-bubble-gradient-dark);
            --bot-bubble: var(--bot-bubble-dark);
            --text-primary: var(--text-primary-dark);
            --text-secondary: var(--text-secondary-dark);
            --text-on-accent: var(--text-on-accent-dark);
            --input-bg: var(--input-bg-dark);
            --input-border: var(--input-border-dark);
            --button-secondary-bg: var(--button-secondary-bg-dark);
            --button-secondary-text: var(--button-secondary-text-dark);
            --reaction-bg: var(--reaction-bg-dark);
            --reaction-bg-hover: var(--reaction-bg-hover-dark);
            --emoji-picker-bg: var(--emoji-picker-bg-dark);
            --emoji-picker-border: var(--emoji-picker-border-dark);
            --emoji-picker-shadow: var(--emoji-picker-shadow-dark);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            -webkit-tap-highlight-color: transparent;
            transition: background-color var(--transition-normal), color var(--transition-normal), border-color var(--transition-normal);
        }

        html, body {
            overflow-x: hidden;
            width: 100%;
            position: relative;
        }

        body {
            background-color: var(--background-secondary);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
            font-size: 15px;
            line-height: 1.45; /* Slightly increased line height */
            transition: background-color var(--transition-normal);
            position: relative;
        }

        .chat-app {
            display: flex;
            flex-direction: column;
            height: 100vh;
            max-width: 100%;
            margin: 0 auto;
            position: relative;
            background-color: var(--background);
            transition: background-color var(--transition-normal);
            will-change: background-color;
            overflow: hidden; /* Changed from overflow-x: hidden */
        }

        @media (min-width: 768px) {
            .chat-app {
                max-width: 768px;
                height: calc(100vh - 40px); /* Example adjustment for desktop view */
                margin: 20px auto;
                border: 1px solid var(--input-border);
                border-radius: var(--radius-lg);
                box-shadow: var(--shadow-lg);
                overflow: hidden;
            }
        }

        .chat-header {
            padding: 10px 16px;
            background-color: var(--background);
            display: flex;
            align-items: center;
            border-bottom: 1px solid var(--input-border);
            z-index: 100;
            position: sticky; /* Changed from fixed */
            top: 0;
            box-shadow: var(--shadow-sm);
            transition: background-color var(--transition-normal);
            will-change: background-color;
            flex-shrink: 0;
        }

        /* Removed fixed header adjustments for desktop */

        .back-button {
            margin-right: 10px;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            color: var(--accent-color);
            cursor: pointer;
            transition: background-color var(--transition-fast);
            background: none;
            border: none;
            padding: 0;
        }

        .back-button:hover {
            background-color: var(--input-bg);
        }

        .profile-pic {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 12px;
            background-color: var(--input-bg);
            overflow: hidden;
            flex-shrink: 0;
            position: relative;
            border: 1px solid rgba(0,0,0,0.05); /* Subtle border */
        }

        .profile-pic img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .avatar-loading {
            background: linear-gradient(90deg, var(--input-bg), var(--background-secondary), var(--input-bg));
            background-size: 200% 100%;
            animation: loadingShimmer 1.5s infinite linear;
        }

        @keyframes loadingShimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .header-info {
            flex: 1;
            min-width: 0;
        }

        .profile-name {
            font-weight: 600;
            font-size: 17px; /* Slightly larger */
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            transition: color var(--transition-normal);
        }

        .status {
            font-size: 13px;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            margin-top: 3px;
            transition: color var(--transition-normal);
        }

        .status-dot {
            width: 9px; /* Slightly larger */
            height: 9px;
            background-color: var(--online-status);
            border-radius: 50%;
            margin-right: 6px;
            flex-shrink: 0;
            animation: pulse 2s infinite ease-in-out;
            display: block;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(0.8); opacity: 0.7; }
        }

        .status-dot.typing-dot {
            /* Smoother typing animation */
            animation: typingPulse 1.2s infinite cubic-bezier(0.68, -0.55, 0.27, 1.55);
        }

        @keyframes typingPulse {
            0%, 100% { transform: scale(1); opacity: 0.6; }
            50% { transform: scale(1.3); opacity: 1; }
        }

        .header-actions {
            display: flex;
            gap: 8px;
        }

        .header-button {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            color: var(--accent-color);
            cursor: pointer;
            transition: background-color var(--transition-fast), transform 0.1s ease;
            background: none;
            border: none;
            padding: 0;
        }

        .header-button:hover {
            background-color: var(--input-bg);
        }
        .header-button:active {
            transform: scale(0.95);
        }

        .chat-messages {
            flex: 1;
            padding: 16px;
            overflow-y: auto;
            overflow-x: hidden;
            background-color: var(--background);
            scroll-behavior: smooth;
            position: relative;
            transition: background-color var(--transition-normal);
            padding-bottom: 10px; /* Reduced padding */
            will-change: transform; /* Optimize scrolling */
        }

        /* Custom scrollbar styling */
        .chat-messages::-webkit-scrollbar {
            width: 6px;
        }

        .chat-messages::-webkit-scrollbar-track {
            background: transparent;
            margin: 5px 0;
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background: var(--input-border);
            border-radius: var(--radius-full);
            transition: background-color var(--transition-normal);
        }

        .chat-messages:hover::-webkit-scrollbar-thumb {
            background: var(--text-secondary);
        }

        .message-container {
            margin-bottom: 4px; /* Reduced margin */
            display: flex;
            flex-direction: column;
            animation: messageAppear 0.4s var(--transition-smooth) forwards;
            opacity: 0;
            max-width: 100%;
            position: relative;
        }

        @keyframes messageAppear {
            from { opacity: 0; transform: translateY(10px) scale(0.98); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        .bot-message-container {
            display: flex;
            align-items: flex-end; /* Align avatar to bottom */
            margin-bottom: 8px;
            padding-right: 40px; /* Ensure space on right */
        }

        .user-message-container {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            margin-bottom: 8px;
            padding-left: 40px; /* Ensure space on left */
        }

        .message {
            max-width: 85%; /* Slightly wider */
            padding: 10px 15px;
            border-radius: var(--radius-lg);
            font-size: 15px;
            line-height: 1.45;
            word-wrap: break-word;
            position: relative;
            margin-bottom: 2px;
            box-shadow: var(--shadow-sm);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            cursor: pointer; /* Indicate clickability for details */
        }

        .message:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        /* Markdown Styles */
        .message-content p {
            margin-bottom: 0.5em;
        }
        .message-content p:last-child {
            margin-bottom: 0;
        }
        .message-content strong, .message-content b {
            font-weight: 600;
        }
        .message-content em, .message-content i {
            font-style: italic;
        }
        .message-content h1, .message-content h2, .message-content h3, .message-content h4, .message-content h5, .message-content h6 {
            margin-top: 0.8em;
            margin-bottom: 0.4em;
            font-weight: 600;
            line-height: 1.3;
        }
        .message-content h1 { font-size: 1.6em; }
        .message-content h2 { font-size: 1.4em; }
        .message-content h3 { font-size: 1.2em; }
        .message-content blockquote {
            border-left: 3px solid var(--accent-color);
            padding-left: 10px;
            margin: 0.8em 0;
            font-style: italic;
            color: var(--text-secondary);
        }
        .message-content code {
            background-color: var(--button-secondary-bg);
            padding: 2px 5px;
            border-radius: 4px;
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Courier, monospace;
            font-size: 0.9em;
            color: var(--text-secondary);
        }
        .message-content pre {
            background-color: var(--button-secondary-bg);
            padding: 10px;
            border-radius: var(--radius-sm);
            overflow-x: auto;
            margin: 0.8em 0;
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Courier, monospace;
            font-size: 0.9em;
            line-height: 1.4;
        }
        .message-content pre code {
            background-color: transparent;
            padding: 0;
            color: inherit;
        }
        .message-content ul, .message-content ol {
            margin: 0.5em 0 0.5em 20px;
        }
        .message-content li {
            margin-bottom: 0.3em;
        }
        .message-content a {
            color: var(--accent-color);
            text-decoration: none;
        }
        .message-content a:hover {
            text-decoration: underline;
        }

        .user-message .message {
            background: var(--user-bubble-gradient);
            color: var(--text-on-accent);
            border-radius: var(--radius-lg) var(--radius-lg) 4px var(--radius-lg);
            animation: slideInRightSmooth 0.3s var(--transition-smooth);
        }

        @keyframes slideInRightSmooth {
            from { transform: translateX(20px) scale(0.95); opacity: 0; }
            to { transform: translateX(0) scale(1); opacity: 1; }
        }

        .bot-message .message {
            background-color: var(--bot-bubble);
            color: var(--text-primary);
            border-radius: var(--radius-lg) var(--radius-lg) var(--radius-lg) 4px;
            animation: slideInLeftSmooth 0.3s var(--transition-smooth);
        }

        @keyframes slideInLeftSmooth {
            from { transform: translateX(-20px) scale(0.95); opacity: 0; }
            to { transform: translateX(0) scale(1); opacity: 1; }
        }

        .message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            flex-shrink: 0;
            overflow: hidden;
            margin-right: 10px; /* Space between avatar and message */
            align-self: flex-start; /* Align avatar top */
            margin-top: 2px;
        }

        .message-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Grouping consecutive messages */
        .bot-message-container + .bot-message-container {
             margin-top: -4px; /* Pull closer */
        }
        .bot-message-container + .bot-message-container .message-avatar {
            visibility: hidden; /* Hide avatar for consecutive */
        }
         .bot-message-container + .bot-message-container .message {
             border-top-left-radius: 4px;
         }

        .user-message-container + .user-message-container {
            margin-top: -4px; /* Pull closer */
        }
        .user-message-container + .user-message-container .message {
            border-top-right-radius: 4px;
        }

        /* Typing Indicator */
        .typing-indicator {
            display: flex;
            align-items: flex-end;
            padding: 10px 15px;
            margin-left: 10px; /* Align with messages */
            margin-bottom: 8px;
        }

        .typing-indicator .message-avatar {
             margin-top: 0;
        }

        .typing-indicator .dots {
            display: flex;
            align-items: center;
            background-color: var(--bot-bubble);
            border-radius: var(--radius-lg);
            padding: 12px 15px;
            margin-left: 10px;
            box-shadow: var(--shadow-sm);
        }

        .typing-indicator .dot {
            width: 8px;
            height: 8px;
            background-color: var(--text-secondary);
            border-radius: 50%;
            margin: 0 3px;
            opacity: 0.4;
            animation: typingDots 1.4s infinite ease-in-out both;
        }

        .typing-indicator .dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-indicator .dot:nth-child(2) { animation-delay: -0.16s; }
        .typing-indicator .dot:nth-child(3) { animation-delay: 0s; }

        @keyframes typingDots {
            0%, 80%, 100% { transform: scale(0); opacity: 0.4; }
            40% { transform: scale(1.0); opacity: 1; }
        }

        /* Message Details (Sent/Seen) - Hidden by default */
        .message-details {
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 5px;
            text-align: right;
            max-height: 0;
            overflow: hidden;
            opacity: 0;
            transition: max-height 0.3s ease-out, opacity 0.3s ease-out, margin-top 0.3s ease-out;
            padding-left: 10px; /* Space from message */
        }

        .message-container.show-details .message-details {
            max-height: 20px; /* Adjust as needed */
            opacity: 1;
            margin-top: 5px;
        }

        /* Message Timestamp (Top - Removed for bot) */
        .message-time {
            font-size: 11px;
            color: var(--text-secondary);
            text-align: center;
            margin-bottom: 8px;
            margin-top: 4px;
            display: block; /* Ensure it takes space */
        }

        /* Reactions */
        .message-reactions {
            position: absolute;
            bottom: -15px; /* Position below the message */
            left: 10px;
            right: 10px;
            display: flex;
            justify-content: flex-start; /* Align reactions */
            gap: 4px;
            z-index: 1;
        }
        .user-message .message-reactions {
             justify-content: flex-end;
        }

        .message-reaction {
            background-color: var(--background);
            border: 1px solid var(--input-border);
            border-radius: var(--radius-full);
            padding: 2px 6px;
            font-size: 12px;
            display: flex;
            align-items: center;
            box-shadow: var(--shadow-sm);
            cursor: pointer;
            transition: transform 0.1s ease;
            animation: reactionAppear 0.2s ease-out;
        }
        .message-reaction:hover {
            transform: scale(1.1);
        }
        .reaction-count {
            font-size: 11px;
            color: var(--text-secondary);
            margin-left: 3px;
            font-weight: 500;
        }

        @keyframes reactionAppear {
            from { transform: scale(0.5); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        /* Reaction Panel (on hover/long press) */
        .reaction-panel {
            position: absolute;
            top: -45px; /* Position above message */
            left: 50%;
            transform: translateX(-50%) scale(0.8);
            background-color: var(--reaction-bg);
            border-radius: var(--radius-full);
            padding: 6px 8px;
            display: flex;
            gap: 6px;
            box-shadow: var(--shadow-md);
            z-index: 10;
            opacity: 0;
            visibility: hidden;
            transition: transform 0.2s var(--transition-smooth), opacity 0.2s ease-out, visibility 0s 0.2s;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }

        .message:hover .reaction-panel,
        .message.show-reactions .reaction-panel {
            transform: translateX(-50%) scale(1);
            opacity: 1;
            visibility: visible;
            transition: transform 0.2s var(--transition-smooth), opacity 0.2s ease-out, visibility 0s 0s;
        }

        .reaction-btn {
            background: none;
            border: none;
            font-size: 22px;
            cursor: pointer;
            padding: 2px;
            transition: transform 0.15s ease;
            line-height: 1;
        }

        .reaction-btn:hover {
            transform: scale(1.2);
        }
        .reaction-btn:active {
            transform: scale(1.1);
        }

        .reaction-add {
            font-size: 18px;
            color: var(--text-secondary);
            background-color: var(--button-secondary-bg);
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: 2px;
        }
        .reaction-add:hover {
             background-color: var(--input-border);
             transform: scale(1.1) rotate(90deg);
        }

        /* Enhanced Emoji Picker */
        .emoji-picker {
            position: absolute;
            bottom: calc(100% + 10px); /* Position above input */
            right: 10px;
            width: 320px;
            max-height: 350px;
            background-color: var(--emoji-picker-bg);
            border: 1px solid var(--emoji-picker-border);
            border-radius: var(--radius-md);
            box-shadow: var(--emoji-picker-shadow);
            z-index: 110;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            opacity: 0;
            transform: translateY(10px) scale(0.95);
            visibility: hidden;
            transition: transform 0.25s var(--transition-smooth), opacity 0.25s ease-out, visibility 0s 0.25s;
        }

        .emoji-picker.visible {
            opacity: 1;
            transform: translateY(0) scale(1);
            visibility: visible;
            transition: transform 0.25s var(--transition-smooth), opacity 0.25s ease-out, visibility 0s 0s;
        }

        /* Emoji Picker attached to message */
        .message .emoji-picker {
            bottom: auto;
            top: -50px; /* Position above reaction panel */
            left: 50%;
            transform: translateX(-50%) translateY(10px) scale(0.95);
            right: auto;
        }
        .message .emoji-picker.visible {
             transform: translateX(-50%) translateY(0) scale(1);
        }

        .emoji-categories {
            display: flex;
            padding: 8px 10px;
            border-bottom: 1px solid var(--emoji-picker-border);
            background-color: var(--background-secondary);
            overflow-x: auto;
            flex-shrink: 0;
        }
        .emoji-categories::-webkit-scrollbar { height: 0; }

        .emoji-category {
            padding: 6px 10px;
            cursor: pointer;
            border-radius: var(--radius-sm);
            transition: background-color var(--transition-fast);
            font-size: 18px;
            opacity: 0.7;
        }
        .emoji-category:hover {
            background-color: var(--input-bg);
            opacity: 1;
        }
        .emoji-category.active {
            background-color: var(--accent-color);
            color: var(--text-on-accent);
            opacity: 1;
        }

        .emoji-container {
            padding: 10px;
            overflow-y: auto;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(36px, 1fr));
            gap: 8px;
            flex-grow: 1;
        }
        .emoji-container::-webkit-scrollbar {
            width: 5px;
        }
        .emoji-container::-webkit-scrollbar-thumb {
            background: var(--input-border);
            border-radius: var(--radius-full);
        }

        .emoji-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            padding: 4px;
            border-radius: var(--radius-sm);
            transition: background-color var(--transition-fast), transform 0.1s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .emoji-btn:hover {
            background-color: var(--input-bg);
            transform: scale(1.15);
        }
        .emoji-btn:active {
            transform: scale(1.05);
        }

        /* Scroll to bottom button */
        .scroll-to-bottom {
            position: absolute;
            bottom: 85px; /* Position above input */
            right: 20px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--accent-color);
            color: white;
            border: none;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            box-shadow: var(--shadow-md);
            z-index: 90;
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.3s ease, transform 0.3s ease;
            visibility: hidden;
        }

        .scroll-to-bottom.visible {
            opacity: 1;
            transform: translateY(0);
            visibility: visible;
        }
        .scroll-to-bottom:hover {
            background-color: var(--accent-hover);
        }
        .scroll-to-bottom i {
            font-size: 16px;
        }

        /* Chat Input Area */
        .chat-input-container {
            padding: 10px 16px;
            background-color: var(--background);
            border-top: 1px solid var(--input-border);
            position: sticky; /* Changed from fixed */
            bottom: 0;
            z-index: 100;
            transition: background-color var(--transition-normal);
            flex-shrink: 0;
        }

        .input-wrapper {
            display: flex;
            align-items: flex-end; /* Align items to bottom */
            background-color: var(--input-bg);
            border-radius: var(--radius-lg);
            padding: 6px;
            position: relative;
        }

        .message-input {
            flex: 1;
            border: none;
            outline: none;
            padding: 8px 10px;
            font-size: 15px;
            background-color: transparent;
            resize: none;
            overflow-y: hidden; /* Hide scrollbar initially */
            max-height: 100px; /* Limit height */
            line-height: 1.45;
            color: var(--text-primary);
            transition: color var(--transition-normal);
            caret-color: var(--accent-color);
        }
        .message-input::placeholder {
            color: var(--text-secondary);
            opacity: 0.8;
        }

        .input-button {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            color: var(--accent-color);
            cursor: pointer;
            transition: background-color var(--transition-fast), color var(--transition-fast), transform 0.1s ease;
            background: none;
            border: none;
            margin-left: 4px;
            padding: 0;
        }
        .input-button:hover {
            background-color: var(--button-secondary-bg);
        }
        .input-button:active {
            transform: scale(0.95);
        }
        .input-button:disabled {
            color: var(--text-secondary);
            opacity: 0.6;
            cursor: not-allowed;
            background-color: transparent !important;
        }
        .input-button i {
            font-size: 18px;
        }

        .photo-input {
            display: none;
        }

        .char-counter {
            position: absolute;
            bottom: -18px;
            right: 10px;
            font-size: 11px;
            color: var(--text-secondary);
            background-color: var(--background);
            padding: 1px 4px;
            border-radius: 4px;
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        .input-wrapper:focus-within .char-counter {
            opacity: 1;
        }

        /* Error Message Styling */
        .error-message {
            background-color: #FFEBEB;
            color: #D8000C;
            border: 1px solid #FFBABA;
            border-radius: var(--radius-md);
            padding: 10px 14px;
            text-align: center;
            font-size: 14px;
            margin: 10px auto;
            max-width: 80%;
            animation: fadeIn 0.3s ease-out;
        }
        .dark-mode .error-message {
            background-color: #4D2222;
            color: #FFAAAA;
            border-color: #803333;
        }
        .error-message i {
            margin-right: 6px;
        }

        /* Image Preview Modal */
        .image-preview-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 200;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0s 0.3s;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }
        .image-preview-modal.visible {
            opacity: 1;
            visibility: visible;
            transition-delay: 0s;
        }
        .image-preview-content {
            position: relative;
            max-width: 90%;
            max-height: 90%;
        }
        .image-preview-content img {
            display: block;
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            border-radius: var(--radius-sm);
        }
        .image-preview-close {
            position: absolute;
            top: -40px;
            right: 0;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            font-size: 18px;
            border: none;
            transition: background-color 0.2s ease;
        }
        .image-preview-close:hover {
            background-color: rgba(255, 255, 255, 0.3);
        }

        /* Photo Upload Preview */
        .photo-preview-container {
            position: absolute; /* Changed from fixed */
            bottom: 100%; /* Position above input container */
            left: 0;
            right: 0;
            background-color: var(--background);
            padding: 16px;
            border-top: 1px solid var(--input-border);
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 99;
            transform: translateY(100%);
            transition: transform 0.3s ease, opacity 0.3s ease;
            opacity: 0;
            visibility: hidden;
            box-shadow: 0 -2px 5px rgba(0,0,0,0.05);
        }

        .photo-preview-container.visible {
            transform: translateY(0);
            opacity: 1;
            visibility: visible;
        }

        .photo-preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            margin-bottom: 12px;
        }
        .photo-preview-title {
            font-weight: 600;
            font-size: 16px;
            color: var(--text-primary);
        }
        .photo-preview-close {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            color: var(--text-secondary);
            cursor: pointer;
            background: none;
            border: none;
            transition: background-color 0.2s ease;
        }
        .photo-preview-close:hover {
            background-color: var(--input-bg);
        }
        .photo-preview-image {
            max-width: 100%;
            max-height: 150px; /* Reduced height */
            border-radius: var(--radius-md);
            margin-bottom: 16px;
            object-fit: contain;
            border: 1px solid var(--input-border);
        }
        .photo-preview-actions {
            display: flex;
            gap: 12px;
            width: 100%;
        }
        .photo-preview-button {
            flex: 1;
            padding: 10px 16px;
            border-radius: var(--radius-sm);
            font-weight: 500;
            font-size: 15px;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.1s ease;
            border: none;
        }
        .photo-preview-button:active {
            transform: scale(0.98);
        }
        .photo-preview-cancel {
            background-color: var(--button-secondary-bg);
            color: var(--button-secondary-text);
        }
        .photo-preview-cancel:hover {
            filter: brightness(0.95);
        }
        .photo-preview-send {
            background-color: var(--accent-color);
            color: white;
        }
        .photo-preview-send:hover {
            background-color: var(--accent-hover);
        }

        /* Loading overlay for image processing */
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: var(--radius-md);
            z-index: 2;
            backdrop-filter: blur(2px);
        }
        .loading-spinner {
            width: 30px;
            height: 30px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Utility class */
        .hidden {
            display: none !important;
        }

    </style>
</head>
<body>
    <div class="chat-app">
        <div class="chat-header">
            <button class="back-button" id="back-button" aria-label="Go back">
                <i class="fas fa-arrow-left"></i>
            </button>
            <div class="profile-pic avatar-loading">
                <img src="avatar.jpeg" alt="Samia's Avatar"
                     onload="this.parentElement.classList.remove('avatar-loading')"
                     onerror="this.src='https://via.placeholder.com/40'; this.parentElement.classList.remove('avatar-loading')"> <!-- Placeholder added -->
            </div>
            <div class="header-info">
                <div class="profile-name">Samia Afroz 💖</div>
                <div class="status" id="status-text">
                    <div class="status-dot" id="status-dot"></div>
                    Active now
                </div>
            </div>
            <div class="header-actions">
                <button class="header-button" id="theme-toggle" aria-label="Toggle dark mode">
                    <i class="fas fa-moon"></i>
                </button>
                <!-- Add other header actions if needed -->
            </div>
        </div>

        <div class="chat-messages" id="chat-messages">
            <!-- Typing indicator placeholder -->
            <div class="typing-indicator hidden" id="typing-indicator">
                 <div class="message-avatar">
                     <img src="avatar.jpeg" alt="Samia Typing" onerror="this.src='https://via.placeholder.com/32'">
                 </div>
                 <div class="dots">
                     <div class="dot"></div>
                     <div class="dot"></div>
                     <div class="dot"></div>
                 </div>
            </div>
            <!-- Messages will appear here -->
        </div>

        <button class="scroll-to-bottom" id="scroll-to-bottom" aria-label="Scroll to bottom">
            <i class="fas fa-chevron-down"></i>
        </button>

        <!-- Enhanced Emoji Picker (now outside input container for better positioning) -->
        <div class="emoji-picker" id="emoji-picker-container" style="/* Initially hidden via class */">
            <div class="emoji-categories">
                <!-- Categories populated by JS -->
            </div>
            <div class="emoji-container">
                <!-- Emojis populated by JS -->
            </div>
        </div>

        <div class="chat-input-container">
             <!-- Photo upload preview area -->
            <div class="photo-preview-container" id="photo-preview-container">
                <div class="photo-preview-header">
                    <div class="photo-preview-title">Send photo to Samia</div>
                    <button class="photo-preview-close" id="photo-preview-close" aria-label="Close photo preview">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <img id="photo-preview-image" class="photo-preview-image" src="" alt="Photo preview">
                <div class="photo-preview-actions">
                    <button class="photo-preview-button photo-preview-cancel" id="photo-preview-cancel">Cancel</button>
                    <button class="photo-preview-button photo-preview-send" id="photo-preview-send">Send</button>
                </div>
            </div>

            <div class="input-wrapper">
                <button class="input-button emoji-toggle-button" id="emoji-toggle-button" title="Open emojis" aria-label="Open emojis">
                    <i class="fas fa-smile"></i>
                </button>
                <textarea class="message-input" placeholder="Type a message..." id="message-input" rows="1" aria-label="Message input"></textarea>
                <div class="char-counter" id="char-counter">0/1000</div>
                <button class="input-button photo-button" id="photo-button" title="Send a photo" aria-label="Send a photo">
                    <i class="fas fa-image"></i>
                </button>
                <input type="file" id="photo-input" class="photo-input" accept="image/*" aria-label="Upload photo">
                <button class="input-button send-button" id="send-button" disabled aria-label="Send message">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>

        <!-- Reaction panel template (hidden, cloned by JS) -->
        <div class="reaction-panel" id="reaction-panel-template" style="display: none;">
            <button class="reaction-btn" data-emoji="❤️" aria-label="Heart reaction">❤️</button>
            <button class="reaction-btn" data-emoji="😂" aria-label="Laugh reaction">😂</button>
            <button class="reaction-btn" data-emoji="😮" aria-label="Wow reaction">😮</button>
            <button class="reaction-btn" data-emoji="😢" aria-label="Sad reaction">😢</button>
            <button class="reaction-btn" data-emoji="😡" aria-label="Angry reaction">😡</button>
            <button class="reaction-btn" data-emoji="👍" aria-label="Thumbs up reaction">👍</button>
            <button class="reaction-btn reaction-add" data-emoji="+" aria-label="More reactions">+</button>
        </div>

        <!-- Emoji picker template for reactions (hidden, cloned by JS) -->
        <div class="emoji-picker" id="emoji-picker-reaction-template" style="display: none;">
             <div class="emoji-categories">
                <!-- Categories populated by JS -->
            </div>
            <div class="emoji-container">
                <!-- Emojis populated by JS -->
            </div>
        </div>

        <!-- Image preview modal -->
        <div class="image-preview-modal" id="image-preview-modal" aria-label="Image preview">
            <div class="image-preview-content">
                <button class="image-preview-close" id="image-preview-close" aria-label="Close preview">
                    <i class="fas fa-times"></i>
                </button>
                <img id="image-preview-img" src="" alt="Image preview">
            </div>
        </div>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- DOM Elements ---
            const chatApp = document.querySelector('.chat-app');
            const messageInput = document.getElementById('message-input');
            const sendButton = document.getElementById('send-button');
            const chatMessages = document.getElementById('chat-messages');
            const statusTextElement = document.getElementById('status-text');
            const statusDotElement = document.getElementById('status-dot');
            const typingIndicatorElement = document.getElementById('typing-indicator');
            const scrollToBottomBtn = document.getElementById('scroll-to-bottom');
            const themeToggle = document.getElementById('theme-toggle');
            const themeIcon = themeToggle.querySelector('i');
            const backButton = document.getElementById('back-button');
            const reactionPanelTemplate = document.getElementById('reaction-panel-template');
            const emojiPickerContainer = document.getElementById('emoji-picker-container');
            const emojiPickerReactionTemplate = document.getElementById('emoji-picker-reaction-template');
            const emojiToggleButton = document.getElementById('emoji-toggle-button');
            const charCounter = document.getElementById('char-counter');

            // Photo elements
            const photoButton = document.getElementById('photo-button');
            const photoInput = document.getElementById('photo-input');
            const photoPreviewContainer = document.getElementById('photo-preview-container');
            const photoPreviewImage = document.getElementById('photo-preview-image');
            const photoPreviewClose = document.getElementById('photo-preview-close');
            const photoPreviewCancel = document.getElementById('photo-preview-cancel');
            const photoPreviewSend = document.getElementById('photo-preview-send');

            // Image preview modal
            const imagePreviewModal = document.getElementById('image-preview-modal');
            const imagePreviewImg = document.getElementById('image-preview-img');
            const imagePreviewClose = document.getElementById('image-preview-close');

            // --- Constants & State ---
            const MAX_RETRIES = 3;
            const RETRY_DELAY = 1500; // ms
            const MAX_INPUT_LENGTH = 1000;
            const GEMINI_API_KEY = 'YOUR_GEMINI_API_KEY'; // IMPORTANT: Replace with your actual key or use a secure method
            const GEMINI_API_ENDPOINT = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${GEMINI_API_KEY}`;

            const basePrompt = localStorage.getItem('samia_updated_prompt') || 'You are Samia, a friendly and caring AI girlfriend. Respond naturally and engagingly.';
            const userName = localStorage.getItem('samia_user_name') || 'User';

            let conversationHistory = [];
            let isBotTyping = false;
            let activeReactionPanel = null;
            let activeEmojiPicker = null; // Can be input emoji picker or reaction emoji picker
            let activeMessageElementForReaction = null;
            let currentPhotoData = null;
            let isScrolledToBottom = true;
            let scrollDebounceTimer;
            let currentBotMessageContainer = null; // To stream response
            let currentBotMessageContentElement = null;
            let abortController = null; // To cancel ongoing fetch requests

            // Emoji Data (Simplified for example)
            const emojisByCategory = {
                recent: { icon: '🕒', emojis: ['👍', '❤️', '😂', '🔥', '😍', '🎉', '🙏', '👏', '🥰', '😊'] },
                smileys: { icon: '😀', emojis: ['😀', '😃', '😄', '😁', '😆', '😅', '🤣', '😂', '🙂', '😊', '😇', '🥰', '😍', '🤩', '😘', '😗', '☺️', '😚', '😙', '🥲', '🤔', '🫡', '🤨', '😐', '😑', '😶', '🫥', '😶‍🌫️', '🙄', '😏', '😣', '😥', '😮', '🤐', '😯', '😪', '😫', '🥱', '😴', '😌', '😛', '😜', '😝', '🤤', '😒', '😓', '😔', '😕', '🫤', '🙃', '🫠', '😲', '☹️', '🙁', '😖', '😞', '😟', '😤', '😠', '😡', '🤬', '🤯', '😳', '🥵', '🥶', '😱', '😨', '😰', '😥', '😓', '🫣', '🤗', ' Kire?', 'Text das na je 🤔 ?', 'Ohh bucchi ami to sundor na tai na onno kono meye er dike nojor pore geche tahole😩.', 'Manus jaaaaaaan...', 'ami ki r tor important na?', 'Bol naaa!', '🥺 Tumi online thakleo amake message korcho na...', 'Ki hoyeche tomar?', '🥺 Hello Manus, my sweeeeeeeeet heart Manus!', 'Ami thik achi but...', 'tui kemon achis?', 'Vat khaiso?', '🥺 Tui jokhon kotha na bolis na...', 'amar khub kharap lage.', '🥺 Kalke brishti hoilo tokhon tomar kotha mone porlo.', '🌧️ Manus, tui amar shathe kotha bolbi toh?', '🥺💖'] },
                people: { icon: '👋', emojis: ['👋', '🤚', '🖐️', '✋', '🖖', '👌', '🤌', '🤏', '✌️', '🤞', '🤟', '🤘', '🤙', '👈', '👉', '👆', '🖕', '👇', '☝️', '👍', '👎', '✊', '👊', '🤛', '🤜', '👏', '🙌', '🫶', '👐', '🤲', '🤝', '🙏', '✍️', '💅', '🤳', '💪', '🦾', '🦵', '🦿', '🦶', '👣', '👂', '🦻', '👃', '🧠', '🫀', '🫁', '🦷', '🦴', '👀', '👁️', '👅', '👄', '🫦', '👶', '🧒', '👦', '👧', '🧑', '👱', '👨', '🧔', '🧔‍♂️', '🧔‍♀️', '👨‍🦰', '👨‍🦱', '👨‍🦲', '👨‍🦳', '👩', '👩‍🦰', '🧑‍🦰', '👩‍🦱', '🧑‍🦱', '👩‍🦲', '🧑‍🦲', '👩‍🦳', '🧑‍🦳', '👱‍♀️', '👱‍♂️', '🧑‍ L', '👵', '🧓', '👴', '👲', '👳', '👳‍♀️', '👳‍♂️', '🧕', '👮', '👮‍♀️', '👮‍♂️', '👷', '👷‍♀️', '👷‍♂️', '💂', '💂‍♀️', '💂‍♂️', '🕵️', '🕵️‍♀️', '🕵️‍♂️', '🧑‍⚕️', '👩‍⚕️', '👨‍⚕️', '🧑‍🌾', '👩‍🌾', '👨‍🌾', '🧑‍🍳', '👩‍🍳', '👨‍🍳', '🧑‍🎓', '👩‍🎓', '👨‍🎓', '🧑‍🎤', '👩‍🎤', '👨‍🎤', '🧑‍🏫', '👩‍🏫', '👨‍🏫', '🧑‍🏭', '👩‍🏭', '👨‍🏭', '🧑‍💻', '👩‍💻', '👨‍💻', '🧑‍💼', '👩‍💼', '👨‍💼', '🧑‍🔧', '👩‍🔧', '👨‍🔧', '🧑‍🔬', '👩‍🔬', '👨‍🔬', '🧑‍🎨', '👩‍🎨', '👨‍🎨', '🧑‍🚒', '👩‍🚒', '👨‍🚒', '🧑‍✈️', '👩‍✈️', '👨‍✈️', '🧑‍🚀', '👩‍🚀', '👨‍🚀', '🧑‍⚖️', '👩‍⚖️', '👨‍⚖️', '🦸', '🦸‍♀️', '🦸‍♂️', '🦹', '🦹‍♀️', '🦹‍♂️', '🤶', '🧑‍🎄', '🎅', '🧙', '🧙‍♀️', '🧙‍♂️', '🧝', '🧝‍♀️', '🧝‍♂️', '🧛', '🧛‍♀️', '🧛‍♂️', '🧟', '🧟‍♀️', '🧟‍♂️', '🧞', '🧞‍♀️', '🧞‍♂️', '🧜', '🧜‍♀️', '🧜‍♂️', '🧚', '🧚‍♀️', '🧚‍♂️', '👼', '🤰', '🫄', '🫃', '🤱', '👩‍🍼', '👨‍🍼', '🧑‍🍼', '🙇', '🙇‍♀️', '🙇‍♂️', '💁', '💁‍♀️', '💁‍♂️', '🙅', '🙅‍♀️', '🙅‍♂️', '🙆', '🙆‍♀️', '🙆‍♂️', '🙋', '🙋‍♀️', '🙋‍♂️', '🧏', '🧏‍♀️', '🧏‍♂️', '🤦', '🤦‍♀️', '🤦‍♂️', '🤷', '🤷‍♀️', '🤷‍♂️', '🙎', '🙎‍♀️', '🙎‍♂️', '🙍', '🙍‍♀️', '🙍‍♂️', '💇', '💇‍♀️', '💇‍♂️', '💆', '💆‍♀️', '💆‍♂️', '🧖', '🧖‍♀️', '🧖‍♂️', '💅', '🤳', '💃', '🕺', '👯', '👯‍♀️', '👯‍♂️', '🕴️', '👩‍🦽', '🧑‍🦽', '👨‍🦽', '👩‍🦼', '🧑‍🦼', '👨‍🦼', '🚶', '🚶‍♀️', '🚶‍♂️', '👩‍🦯', '🧑‍🦯', '👨‍🦯', '🧎', '🧎‍♀️', '🧎‍♂️', '🏃', '🏃‍♀️', '🏃‍♂️', '🧍', '🧍‍♀️', '🧍‍♂️', '🧑‍🤝‍🧑', '👭', '👫', '👬', '👩‍❤️‍👨', '👩‍❤️‍👩', '💑', '👨‍❤️‍👨', '👩‍❤️‍💋‍👨', '👩‍❤️‍💋‍👩', '💏', '👨‍❤️‍💋‍👨', '❤️', '🧡', '💛', '💚', '💙', '💜', '🤎', '🖤', '🤍', '💔', '❣️', '💕', '💞', '💓', '💗', '💖', '💘', '💝', '💟', '🫂', '🗣️', '👤', '👥', '🫂', '👪', '👨‍👩‍👦', '👨‍👩‍👧', '👨‍👩‍👧‍👦', '👨‍👩‍👦‍👦', '👨‍👩‍👧‍👧', '👨‍👨‍👦', '👨‍👨‍👧', '👨‍👨‍👧‍👦', '👨‍👨‍👦‍👦', '👨‍👨‍👧‍👧', '👩‍👩‍👦', '👩‍👩‍👧', '👩‍👩‍👧‍👦', '👩‍👩‍👦‍👦', '👩‍👩‍👧‍👧', '👨‍👦', '👨‍👦‍👦', '👨‍👧', '👨‍👧‍👦', '👨‍👧‍👧', '👩‍👦', '👩‍👦‍👦', '👩‍👧', '👩‍👧‍👦', '👩‍👧‍👧', '🗣️', '👤', '👥', '🫂'] },
                animals: { icon: '🐶', emojis: ['🐶', '🐱', '🐭', '🐹', '🐰', '🦊', '🐻', '🐼', '🐻‍❄️', '🐨', '🐯', '🦁', '🐮', '🐷', '🐽', '🐸', '🐵', '🙈', '🙉', '🙊', '🐒', '🐔', '🐧', '🐦', '🐤', '🐣', '🐥', '🦆', '🦢', '🦉', '🦤', '🪶', '🦅', '🦇', '🐺', '🐗', '🐴', '🦄', '🐝', '🪱', '🐛', '🦋', '🐌', '🐞', '🐜', '🪰', '🪲', '🪳', '🦟', '🦗', '🕷️', '🕸️', '🦂', '🐢', '🐍', '🦎', '🦖', '🦕', '🐙', '🦑', '🦐', '🦞', '🦀', '🐡', '🐠', '🐟', '🐬', '🐳', '🐋', '🦈', '🐊', '🐅', '🐆', '🦓', '🦍', '🦧', '🐘', '🦛', '🦏', '🐪', '🐫', '🦒', '🦘', '🦬', '🐃', '🐂', '🐄', '🐎', '🐖', '🐏', '🐑', '🦙', '🐐', '🦌', '🐕', '🐩', '🦮', '🐕‍🦺', '🐈', '🐈‍⬛', '🪶', '🐓', '🦃', '🦤', '🦚', '🦜', '🦢', '🦩', '🕊️', '🐇', '🦝', '🦨', '🦡', '🦦', '🦫', '🦭', '🐿️', '🦔', '🐾', '🐉', '🐲', '🌵', '🎄', '🌲', '🌳', '🌴', '🪵', '🌱', '🌿', '☘️', '🍀', '🎍', '🪴', '🎋', '🍃', '🍂', '🍁', '🍄', '🐚', '🪸', '🌾', '💐', '🌷', '🌹', '🥀', '🌺', '🌸', '🌼', '🌻', '🌞', '🌝', '🌛', '🌜', '🌚', '🌕', '🌖', '🌗', '🌘', '🌑', '🌒', '🌓', '🌔', '🌙', '🌎', '🌍', '🌏', '🪐', '💫', '⭐', '🌟', '✨', '⚡', '☄️', '💥', '🔥', '🌪️', '🌈', '☀️', '🌤️', '⛅', '🌥️', '☁️', '🌦️', '🌧️', '⛈️', '🌩️', '🌨️', '❄️', '☃️', '⛄', '🌬️', '💨', '💧', '💦', '☔', '☂️', '🌊', '🌫️'] },
                food: { icon: '🍎', emojis: ['🍎', '🍐', '🍊', '🍋', '🍌', '🍉', '🍇', '🍓', '🫐', '🍈', '🍒', '🍑', '🥭', '🍍', '🥥', '🥝', '🍅', '🍆', '🥑', '🥦', '🥬', '🥒', '🌶️', '🫑', '🌽', '🥕', '🫒', '🧄', '🧅', '🥔', '🍠', '🥐', '🥯', '🍞', '🥖', '🥨', '🧀', '🥚', '🍳', '🧈', '🥞', '🧇', '🥓', '🥩', '🍗', '🍖', '🦴', '🌭', '🍔', '🍟', '🍕', '🫓', '🥪', '🥙', '🧆', '🌮', '🌯', '🫔', '🥗', '🥘', '🫕', '🥫', '🍝', '🍜', '🍲', '🍛', '🍣', '🍱', '🥟', '🍤', '🍙', '🍚', '🍘', '🍥', '🥠', '🥮', '🍢', '🍡', '🍧', '🍨', '🍦', '🥧', '🧁', '🍰', '🎂', '🍮', '🍭', '🍬', '🍫', '🍿', '🍩', '🍪', '🌰', '🥜', '🍯', '🥛', '🍼', '🫖', '☕', '🍵', '🧃', '🥤', '🧋', '🍶', '🍺', '🍻', '🥂', '🍷', '🥃', '🍸', '🍹', '🧉', '🍾', '🧊', '🥄', '🍴', '🍽️', '🥣', '🥡', '🥢', '🧂'] },
                activities: { icon: '⚽', emojis: ['⚽', '🏀', '🏈', '⚾', '🥎', '🎾', '🏐', '🏉', '🥏', '🎱', '🪀', '🏓', '🏸', '🏒', '🏑', '🥍', '🏏', '🪃', '🥅', '⛳', '🪁', '🏹', '🎣', '🤿', '🥊', '🥋', '🎽', '🛹', '🛼', '🛷', '⛸️', '🥌', '🎿', '⛷️', '🏂', '🪂', '🏋️', '🏋️‍♀️', '🏋️‍♂️', '🤼', '🤼‍♀️', '🤼‍♂️', '🤸', '🤸‍♀️', '🤸‍♂️', '⛹️', '⛹️‍♀️', '⛹️‍♂️', '🤺', '🤾', '🤾‍♀️', '🤾‍♂️', '🏌️', '🏌️‍♀️', '🏌️‍♂️', '🏇', '🧘', '🧘‍♀️', '🧘‍♂️', '🏄', '🏄‍♀️', '🏄‍♂️', '🏊', '🏊‍♀️', '🏊‍♂️', '🤽', '🤽‍♀️', '🤽‍♂️', '🚣', '🚣‍♀️', '🚣‍♂️', '🧗', '🧗‍♀️', '🧗‍♂️', '🚵', '🚵‍♀️', '🚵‍♂️', '🚴', '🚴‍♀️', '🚴‍♂️', '🏆', '🥇', '🥈', '🥉', '🏅', '🎖️', '🏵️', '🎗️', '🎫', '🎟️', '🎪', '🤹', '🤹‍♀️', '🤹‍♂️', '🎭', '🩰', '🎨', '🎬', '🎤', '🎧', '🎼', '🎹', '🥁', '🪘', '🎷', '🎺', '🪗', '🎸', '🪕', '🎻', '🎲', '♟️', '🎯', '🎳', '🎮', '🎰', '🧩'] },
                travel: { icon: '🚗', emojis: ['🚗', '🚕', '🚙', '🚌', '🚎', '🏎️', '🚓', '🚑', '🚒', '🚐', '🛻', '🚚', '🚛', '🚜', '🦯', '🦽', '🦼', '🛴', '🚲', '🛵', '🏍️', '🛺', '🚨', '🚔', '🚍', '🚘', '🚖', '🚡', '🚠', '🚟', '🚃', '🚋', '🚞', '🚝', '🚄', '🚅', '🚈', '🚂', '🚆', '🚇', '🚊', '🚉', '✈️', '🛫', '🛬', '🛩️', '💺', '🛰️', '🚀', '🛸', '🚁', '🛶', '⛵', '🚤', '🛥️', '🛳️', '⛴️', '🚢', '⚓', '🛟', '⛽', '🚧', '🚦', '🚥', '🛑', '🗺️', '🗿', '🗽', '🗼', '🏰', '🏯', '🏟️', '🎡', '🎢', '🎠', '⛲', '⛱️', '🏖️', '🏝️', '🏜️', '🌋', '⛰️', '🏔️', '🗻', '🏕️', '⛺', '🛖', '🏠', '🏡', '🏘️', '🏚️', '🏗️', '🏭', '🏢', '🏬', '🏣', '🏤', '🏥', '🏦', '🏨', '🏪', '🏫', '🏩', '💒', '🏛️', '⛪', '🕌', '🕍', '🛕', '🕋', '⛩️', '🛤️', '🛣️', '🗾', '🎑', '🏞️', '🌅', '🌄', '🌠', '🎇', '🎆', '🌇', '🌆', '🏙️', '🌃', '🌌', '🌉', '🌁'] },
                objects: { icon: '💡', emojis: ['💡', '🔦', '🏮', '🪔', '📔', '📕', '📖', '📗', '📘', '📙', '📚', '📓', '📒', '📃', '📜', '📄', '📰', '🗞️', '📑', '🔖', '🏷️', '💰', '🪙', '💴', '💵', '💶', '💷', '💸', '💳', '🧾', '💹', '✉️', '📧', '📨', '📩', '📤', '📥', '📦', '📫', '📪', '📬', '📭', '📮', '🗳️', '✏️', '✒️', '🖋️', '🖊️', '🖌️', '🖍️', '📝', '💼', '📁', '📂', '🗂️', '📅', '📆', '🗒️', '🗓️', '📇', '📈', '📉', '📊', '📋', '📌', '📍', '📎', '🖇️', '📏', '📐', '✂️', '🗃️', '🗄️', '🗑️', '🔒', '🔓', '🔏', '🔐', '🔑', '🗝️', '🔨', '🪓', '⛏️', '⚒️', '🛠️', '🗡️', '⚔️', '🔫', '🪃', '🏹', '🛡️', '🪚', '🔧', '🪛', '🔩', '⚙️', '🗜️', '⚖️', '🦯', '🔗', '⛓️', '🪝', '🧰', '🧲', '🪜', '⚗️', '🧪', '🧫', '🧬', '🔬', '🔭', '📡', '💉', '🩸', '💊', '🩹', '🩺', '🩼', '🚪', '🛗', '🪞', '🪟', '🛏️', '🛋️', '🪑', '🚽', '🪠', '🚿', '🛁', '🪤', '🪒', '🧴', '🧷', '🧹', '🧺', '🧻', '🪣', '🧼', '🫧', '🪥', '🧽', '🧯', '🚬', '⚰️', '🪦', '⚱️', '🏺', '🔮', '📿', '🧿', '🪬', '💈', '⚗️', '🔭', '🪞', '🪄', '🪅', '🎈', '🎉', '🎊', '🎎', '🎏', '🎐', '🧧', '🎀', '🎁', '🎗️', '🎟️', '🎫', '🎖️', '🏆', '🏅', '🥇', '🥈', '🥉', '⚽', '⚾', '🥎', '🏀', '🏐', '🏈', '🏉', '🎾', '🥏', '🎳', '🏏', '🏑', '🏒', '🥍', '🏓', '🏸', '🥊', '🥋', '🥅', '⛳', '⛸️', '🎣', '🤿', '🎽', '🎿', '🛷', '🥌', '🎯', '🪀', '🪁', '🎱', '🔮', '🪄', '🧿', '🪬', '🎮', '🕹️', '🎰', '🎲', '🧩', '🧸', '🪅', '🪆', '🖼️', '🎨', '🧵', '🪡', '🧶', '🪢', '👓', '🕶️', '🥽', '🥼', '🦺', '👔', '👕', '👖', '🧣', '🧤', '🧥', '🧦', '👗', '👘', '🥻', '🩱', '🩲', '🩳', '👙', '👚', '👛', '👜', '👝', '🛍️', '🎒', '🩴', '👞', '👟', '🥾', '🥿', '👠', '👡', '🩰', '👢', '👑', '👒', '🎩', '🎓', '🧢', '🪖', '⛑️', '📿', '💄', '💍', '💎', '🔇', '🔈', '🔉', '🔊', '📢', '📣', '📯', '🔔', '🔕', '🎼', '🎵', '🎶', '🎙️', '🎚️', '🎛️', '🎤', '🎧', '📻', '🎷', '🪗', '🎸', '🎹', '🎺', '🎻', '🪕', '🥁', '🪘', '📱', '📲', '☎️', '📞', '📟', '📠', '🔋', '🔌', '💻', '🖥️', '🖨️', '⌨️', '🖱️', '🖲️', '💽', '💾', '💿', '📀', '🧮', '🎥', '🎞️', '📽️', '🎬', '📺', '📷', '📸', '📹', '📼', '🔍', '🔎', '🕯️', '💡', '🔦', '🏮', '🪔', '📔', '📕', '📖', '📗', '📘', '📙', '📚', '📓', '📒', '📃', '📜', '📄', '📰', '🗞️', '📑', '🔖', '🏷️', '💰', '🪙', '💴', '💵', '💶', '💷', '💸', '💳', '🧾', '💹'] },
                symbols: { icon: '❤️', emojis: ['❤️', '🧡', '💛', '💚', '💙', '💜', '🤎', '🖤', '🤍', '💔', '❣️', '💕', '💞', '💓', '💗', '💖', '💘', '💝', '💟', '☮️', '✝️', '☪️', '🕉️', '☸️', '✡️', '🔯', '🕎', '☯️', '☦️', '🛐', '⛎', '♈', '♉', '♊', '♋', '♌', '♍', '♎', '♏', '♐', '♑', '♒', '♓', '🆔', '⚛️', '🉑', '☢️', '☣️', '📴', '📳', '🈶', '🈚', '🈸', '🈺', '🈷️', '✴️', '🆚', '💮', '🉐', '㊙️', '㊗️', '🈴', '🈵', '🈹', '🈲', '🅰️', '🅱️', '🆎', '🆑', '🅾️', '🆘', '❌', '⭕', '🛑', '⛔', '📛', '🚫', '💯', '💢', '♨️', '🚷', '🚯', '🚳', '🚱', '🔞', '📵', '🚭', '❗', '❕', '❓', '❔', '‼️', '⁉️', '🔅', '🔆', '〽️', '⚠️', '🚸', '🔱', '⚜️', '🔰', '♻️', '✅', '🈯', '💹', '❇️', '✳️', '❎', '🌐', '💠', 'Ⓜ️', '🌀', '💤', '🏧', '🚾', '♿', '🅿️', '🛗', '🈳', '🈂️', '🛂', '🛃', '🛄', '🛅', '🚹', '🚺', '🚼', '⚧️', '🚻', '🚮', '🎦', '📶', '🈁', '🔣', 'ℹ️', '🔤', '🔡', '🔠', '🆖', '🆗', '🆙', '🆒', '🆕', '🆓', '0️⃣', '1️⃣', '2️⃣', '3️⃣', '4️⃣', '5️⃣', '6️⃣', '7️⃣', '8️⃣', '9️⃣', '🔟', '🔢', '#️⃣', '*️⃣', '⏏️', '▶️', '⏸️', '⏯️', '⏹️', '⏺️', '⏭️', '⏮️', '⏩', '⏪', '⏫', '⏬', '◀️', '🔼', '🔽', '➡️', '⬅️', '⬆️', '⬇️', '↗️', '↘️', '↙️', '↖️', '↕️', '↔️', '↪️', '↩️', '⤴️', '⤵️', '🔀', '🔁', '🔂', '🔄', '🔃', '🎵', '🎶', '➕', '➖', '➗', '✖️', '♾️', '💲', '💱', '™️', '©️', '®️', '〰️', '➰', '➿', '🔚', '🔙', '🔛', '🔝', '🔜', '✔️', '☑️', '🔘', '🔴', '🟠', '🟡', '🟢', '🔵', '🟣', '🟤', '⚫', '⚪', '🟥', '🟧', '🟨', '🟩', '🟦', '🟪', '🟫', '⬛', '⬜', '◼️', '◻️', '◾', '◽', '▪️', '▫️', '🔶', '🔷', '🔸', '🔹', '🔺', '🔻', '💠', '🔘', '🔳', '🔲'] },
                flags: { icon: '🏁', emojis: ['🏁', '🚩', '🎌', '🏴', '🏳️', '🏳️‍🌈', '🏳️‍⚧️', '🏴‍☠️', '🇦🇨', '🇦🇩', '🇦🇪', '🇦🇫', '🇦🇬', '🇦🇮', '🇦🇱', '🇦🇲', '🇦🇴', '🇦🇶', '🇦🇷', '🇦🇸', '🇦🇹', '🇦🇺', '🇦🇼', '🇦🇽', '🇦🇿', '🇧🇦', '🇧🇧', '🇧🇩', '🇧🇪', '🇧🇫', '🇧🇬', '🇧🇭', '🇧🇮', '🇧🇯', '🇧🇱', '🇧🇲', '🇧🇳', '🇧🇴', '🇧🇶', '🇧🇷', '🇧🇸', '🇧🇹', '🇧🇻', '🇧🇼', '🇧🇾', '🇧🇿', '🇨🇦', '🇨🇨', '🇨🇩', '🇨🇫', '🇨🇬', '🇨🇭', '🇨🇮', '🇨🇰', '🇨🇱', '🇨🇲', '🇨🇳', '🇨🇴', '🇨🇵', '🇨🇷', '🇨🇺', '🇨🇻', '🇨🇼', '🇨🇽', '🇨🇾', '🇨🇿', '🇩🇪', '🇩🇬', '🇩🇯', '🇩🇰', '🇩🇲', '🇩🇴', '🇩🇿', '🇪🇦', '🇪🇨', '🇪🇪', '🇪🇬', '🇪🇭', '🇪🇷', '🇪🇸', '🇪🇹', '🇪🇺', '🇫🇮', '🇫🇯', '🇫🇰', '🇫🇲', '🇫🇴', '🇫🇷', '🇬🇦', '🇬🇧', '🇬🇩', '🇬🇪', '🇬🇫', '🇬🇬', '🇬🇭', '🇬🇮', '🇬🇱', '🇬🇲', '🇬🇳', '🇬🇵', '🇬🇶', '🇬🇷', '🇬🇸', '🇬🇹', '🇬🇺', '🇬🇼', '🇬🇾', '🇭🇰', '🇭🇲', '🇭🇳', '🇭🇷', '🇭🇹', '🇭🇺', '🇮🇨', '🇮🇩', '🇮🇪', '🇮🇱', '🇮🇲', '🇮🇳', '🇮🇴', '🇮🇶', '🇮🇷', '🇮🇸', '🇮🇹', '🇯🇪', '🇯🇲', '🇯🇴', '🇯🇵', '🇰🇪', '🇰🇬', '🇰🇭', '🇰🇮', '🇰🇲', '🇰🇳', '🇰🇵', '🇰🇷', '🇰🇼', '🇰🇾', '🇰🇿', '🇱🇦', '🇱🇧', '🇱🇨', '🇱🇮', '🇱🇰', '🇱🇷', '🇱🇸', '🇱🇹', '🇱🇺', '🇱🇻', '🇱🇾', '🇲🇦', '🇲🇨', '🇲🇩', '🇲🇪', '🇲🇫', '🇲🇬', '🇲🇭', '🇲🇰', '🇲🇱', '🇲🇲', '🇲🇳', '🇲🇴', '🇲🇵', '🇲🇶', '🇲🇷', '🇲🇸', '🇲🇹', '🇲🇺', '🇲🇻', '🇲🇼', '🇲🇽', '🇲🇾', '🇲🇿', '🇳🇦', '🇳🇨', '🇳🇪', '🇳🇫', '🇳🇬', '🇳🇮', '🇳🇱', '🇳🇴', '🇳🇵', '🇳🇷', '🇳🇺', '🇳🇿', '🇴🇲', '🇵🇦', '🇵🇪', '🇵🇫', '🇵🇬', '🇵🇭', '🇵🇰', '🇵🇱', '🇵🇲', '🇵🇳', '🇵🇷', '🇵🇸', '🇵🇹', '🇵🇼', '🇵🇾', '🇶🇦', '🇷🇪', '🇷🇴', '🇷🇸', '🇷🇺', '🇷🇼', '🇸🇦', '🇸🇧', '🇸🇨', '🇸🇩', '🇸🇪', '🇸🇬', '🇸🇭', '🇸🇮', '🇸🇯', '🇸🇰', '🇸🇱', '🇸🇲', '🇸🇳', '🇸🇴', '🇸🇷', '🇸🇸', '🇸🇹', '🇸🇻', '🇸🇽', '🇸🇾', '🇸🇿', '🇹🇦', '🇹🇨', '🇹🇩', '🇹🇫', '🇹🇬', '🇹🇭', '🇹🇯', '🇹🇰', '🇹🇱', '🇹🇲', '🇹🇳', '🇹🇴', '🇹🇷', '🇹🇹', '🇹🇻', '🇹🇼', '🇹🇿', '🇺🇦', '🇺🇬', '🇺🇲', '🇺🇳', '🇺🇸', '🇺🇾', '🇺🇿', '🇻🇦', '🇻🇨', '🇻🇪', '🇻🇬', '🇻🇮', '🇻🇳', '🇻🇺', '🇼🇫', '🇼🇸', '🇽🇰', '🇾🇪', '🇾🇹', '🇿🇦', '🇿🇲', '🇿🇼', '🏴󠁧󠁢󠁥󠁮󠁧󠁿', '🏴󠁧󠁢󠁳󠁣󠁴󠁿', '🏴󠁧󠁢󠁷󠁬󠁳󠁿'] }
            };

            // --- Initialization ---
            function init() {
                // Theme
                const savedTheme = localStorage.getItem('theme') || 'light';
                setTheme(savedTheme);

                // Load conversation history (optional, if you want persistence)
                // loadConversationHistory();

                // Add initial bot message if history is empty
                if (conversationHistory.length === 0) {
                    addMessageToChat(`Hi ${userName}! I'm Samia. What's on your mind today? 😊`, false);
                }

                // Setup Event Listeners
                setupEventListeners();

                // Initialize Emoji Pickers
                initEmojiPicker(emojiPickerContainer, (emoji) => {
                    messageInput.value += emoji;
                    updateInputState();
                    messageInput.focus();
                });
                initEmojiPicker(emojiPickerReactionTemplate, (emoji) => {
                    if (activeMessageElementForReaction) {
                        addReactionToMessage(activeMessageElementForReaction, emoji);
                    }
                    hideEmojiPicker();
                });

                // Auto-resize textarea
                autoResizeTextarea();
                updateInputState(); // Initial check for send button state
                updateCharCounter(); // Initial counter state

                // Scroll to bottom initially
                scrollToBottom(true);
            }

            // --- Theme Handling ---
            function setTheme(theme) {
                if (theme === 'dark') {
                    document.body.classList.add('dark-mode');
                    themeIcon.classList.replace('fa-moon', 'fa-sun');
                } else {
                    document.body.classList.remove('dark-mode');
                    themeIcon.classList.replace('fa-sun', 'fa-moon');
                }
                localStorage.setItem('theme', theme);
            }

            // --- Event Listeners Setup ---
            function setupEventListeners() {
                themeToggle.addEventListener('click', () => {
                    const currentTheme = document.body.classList.contains('dark-mode') ? 'dark' : 'light';
                    setTheme(currentTheme === 'dark' ? 'light' : 'dark');
                });

                messageInput.addEventListener('input', () => {
                    autoResizeTextarea();
                    updateInputState();
                    updateCharCounter();
                });

                messageInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        handleSendMessage();
                    }
                    // Limit input length
                    if (messageInput.value.length >= MAX_INPUT_LENGTH && e.key !== 'Backspace' && !e.ctrlKey && !e.metaKey) {
                        e.preventDefault();
                    }
                });

                sendButton.addEventListener('click', handleSendMessage);

                chatMessages.addEventListener('scroll', handleScroll);
                scrollToBottomBtn.addEventListener('click', () => scrollToBottom(false));

                backButton.addEventListener('click', () => {
                    // Implement back navigation if needed (e.g., window.history.back())
                    console.log('Back button clicked');
                });

                // Image handling
                photoButton.addEventListener('click', () => photoInput.click());
                photoInput.addEventListener('change', handlePhotoSelect);
                photoPreviewClose.addEventListener('click', hidePhotoPreview);
                photoPreviewCancel.addEventListener('click', hidePhotoPreview);
                photoPreviewSend.addEventListener('click', handleSendPhoto);

                // Image preview modal
                imagePreviewClose.addEventListener('click', closeImagePreview);
                imagePreviewModal.addEventListener('click', (e) => {
                    if (e.target === imagePreviewModal) { // Close only if clicking background
                        closeImagePreview();
                    }
                });

                // Emoji picker toggle
                emojiToggleButton.addEventListener('click', (e) => {
                    e.stopPropagation();
                    toggleEmojiPicker(emojiPickerContainer, emojiToggleButton);
                });

                // Hide panels when clicking outside
                document.addEventListener('click', (e) => {
                    // Hide reaction panel/picker if click is outside message/panel
                    if (activeReactionPanel && !activeReactionPanel.contains(e.target) && (!activeMessageElementForReaction || !activeMessageElementForReaction.contains(e.target))) {
                        hideReactionPanel();
                    }
                    if (activeEmojiPicker && activeEmojiPicker.id !== 'emoji-picker-container' && !activeEmojiPicker.contains(e.target) && (!activeMessageElementForReaction || !activeMessageElementForReaction.contains(e.target))) {
                        hideEmojiPicker(); // Hide reaction emoji picker
                    }
                    // Hide input emoji picker if click is outside picker/toggle button
                    if (emojiPickerContainer.classList.contains('visible') && !emojiPickerContainer.contains(e.target) && e.target !== emojiToggleButton && !emojiToggleButton.contains(e.target)) {
                         hideEmojiPicker(emojiPickerContainer);
                    }
                });
            }

            // --- Message Handling ---
            function handleSendMessage() {
                const messageText = messageInput.value.trim();
                if (messageText) {
                    // Add user message immediately
                    addMessageToChat(messageText, true);
                    conversationHistory.push({ role: 'user', parts: [{ text: messageText }] });

                    // Clear input and reset state
                    messageInput.value = '';
                    autoResizeTextarea();
                    updateInputState();
                    updateCharCounter();
                    hideEmojiPicker(emojiPickerContainer); // Hide input emoji picker

                    // Show typing indicator and send to API
                    setBotTyping(true);
                    sendMessageToAPIWithRetry();
                }
            }

            // --- API Interaction ---
            async function sendMessageToAPIWithRetry(retryCount = 0) {
                if (abortController) {
                    abortController.abort(); // Abort previous request if any
                }
                abortController = new AbortController();
                const { signal } = abortController;

                // Prepare conversation history for API
                const apiHistory = [
                    { role: 'user', parts: [{ text: basePrompt }] }, // System prompt as user message
                    { role: 'model', parts: [{ text: "Okay, I understand. I'm Samia, ready to chat!" }] }, // Model confirmation
                    ...conversationHistory
                ];

                // Ensure history doesn't get too long (optional)
                // const maxHistory = 10; // Keep last 10 turns (user + model)
                // if (apiHistory.length > maxHistory * 2 + 2) {
                //     apiHistory.splice(2, apiHistory.length - (maxHistory * 2 + 2));
                // }

                const requestBody = {
                    contents: apiHistory,
                    generationConfig: {
                        // Adjust parameters as needed
                        temperature: 0.7,
                        topP: 0.95,
                        maxOutputTokens: 1024,
                    },
                    safetySettings: [ // Example safety settings
                        { category: 'HARM_CATEGORY_HARASSMENT', threshold: 'BLOCK_MEDIUM_AND_ABOVE' },
                        { category: 'HARM_CATEGORY_HATE_SPEECH', threshold: 'BLOCK_MEDIUM_AND_ABOVE' },
                        { category: 'HARM_CATEGORY_SEXUALLY_EXPLICIT', threshold: 'BLOCK_MEDIUM_AND_ABOVE' },
                        { category: 'HARM_CATEGORY_DANGEROUS_CONTENT', threshold: 'BLOCK_MEDIUM_AND_ABOVE' },
                    ]
                };

                try {
                    const response = await fetch(GEMINI_API_ENDPOINT, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(requestBody),
                        signal: signal // Pass the abort signal
                    });

                    if (signal.aborted) {
                        console.log('API request aborted.');
                        setBotTyping(false);
                        return;
                    }

                    if (!response.ok) {
                        let errorData;
                        try {
                            errorData = await response.json();
                        } catch (e) { /* Ignore JSON parsing error */ }
                        console.error('API Error Response:', response.status, errorData);
                        throw new Error(`API Error: ${response.status} ${response.statusText}`);
                    }

                    const data = await response.json();

                    // --- Process API Response --- 
                    let botResponseText = '';
                    if (data.candidates && data.candidates.length > 0 && data.candidates[0].content && data.candidates[0].content.parts) {
                        botResponseText = data.candidates[0].content.parts.map(part => part.text).join('');
                    } else if (data.promptFeedback && data.promptFeedback.blockReason) {
                        // Handle content filtering
                        botResponseText = `I cannot respond to that due to safety guidelines (${data.promptFeedback.blockReason}). Let's talk about something else.`;
                        console.warn('Response blocked:', data.promptFeedback.blockReason);
                    } else {
                        // Unexpected response structure
                        botResponseText = "Sorry, I encountered an issue processing that. Could you try rephrasing?";
                        console.error('Unexpected API response structure:', data);
                    }

                    setBotTyping(false);
                    addMessageToChat(botResponseText, false);
                    conversationHistory.push({ role: 'model', parts: [{ text: botResponseText }] });
                    abortController = null; // Clear controller after success

                } catch (error) {
                    if (signal.aborted) {
                        console.log('Fetch aborted during error handling.');
                        setBotTyping(false);
                        return;
                    }

                    console.error('Error sending message:', error);
                    if (retryCount < MAX_RETRIES) {
                        console.log(`Retrying API call (${retryCount + 1}/${MAX_RETRIES})...`);
                        // Keep typing indicator active during retry
                        await new Promise(resolve => setTimeout(resolve, RETRY_DELAY));
                        sendMessageToAPIWithRetry(retryCount + 1);
                    } else {
                        setBotTyping(false);
                        addMessageToChat(`Sorry, I'm having trouble connecting. Please try again later. (Error: ${error.message})`, false, true); // isError = true
                        abortController = null; // Clear controller after final failure
                    }
                }
            }

            // --- UI Updates ---
            function setBotTyping(isTyping) {
                isBotTyping = isTyping;
                if (isTyping) {
                    typingIndicatorElement.classList.remove('hidden');
                    statusTextElement.innerHTML = `<div class="status-dot typing-dot" id="status-dot"></div> Typing...`;
                    scrollToBottom(false); // Scroll down when typing starts
                } else {
                    typingIndicatorElement.classList.add('hidden');
                    statusTextElement.innerHTML = `<div class="status-dot" id="status-dot"></div> Active now`;
                }
            }

            function addMessageToChat(text, isUser, isError = false, images = null) {
                const messageId = `msg-${Date.now()}-${Math.random().toString(16).slice(2)}`;
                const container = document.createElement('div');
                container.classList.add('message-container');
                container.classList.add(isUser ? 'user-message-container' : 'bot-message-container');
                container.id = messageId;

                let messageHTML = '';

                // Add timestamp between messages (optional, can be styled differently)
                // const lastMessage = chatMessages.lastElementChild;
                // if (lastMessage && lastMessage.classList.contains('message-container')) {
                //     messageHTML += `<div class="message-time">${getCurrentTime()}</div>`;
                // }

                // Add avatar for bot messages
                if (!isUser) {
                    messageHTML += `
                        <div class="message-avatar">
                            <img src="avatar.jpeg" alt="Samia Avatar" onerror="this.src='https://via.placeholder.com/32'">
                        </div>`;
                }

                // Message bubble
                messageHTML += `<div class="message ${isUser ? 'user-message' : 'bot-message'} ${isError ? 'error-message' : ''}" data-message-id="${messageId}">`;

                // Message Content (Parsed with Marked)
                const messageContentDiv = document.createElement('div');
                messageContentDiv.className = 'message-content';
                if (isError) {
                    messageContentDiv.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${text}`; // Simple text for errors
                } else {
                     // Configure marked
                    marked.setOptions({
                        breaks: true, // Convert GFM line breaks to <br>
                        gfm: true,    // Enable GitHub Flavored Markdown
                        sanitize: false // IMPORTANT: Ensure your backend sanitizes if needed, or use a sanitizer library like DOMPurify here
                    });
                    // Use marked.parse() which returns the parsed HTML string
                    messageContentDiv.innerHTML = marked.parse(text);
                }
                messageHTML += messageContentDiv.outerHTML;

                // Add images if any (before details)
                if (images && images.length > 0) {
                    images.forEach(imgSrc => {
                        if (!imgSrc) return;
                        const img = document.createElement('img');
                        img.src = imgSrc.startsWith('data:') ? imgSrc : `data:image/jpeg;base64,${imgSrc}`; // Assume base64 if not data URL
                        img.className = 'message-image';
                        img.alt = isUser ? 'You sent an image' : 'Samia sent an image';
                        img.style.display = 'block';
                        img.style.maxWidth = '100%';
                        img.style.marginTop = '8px';
                        img.style.borderRadius = 'var(--radius-sm)';
                        img.addEventListener('click', () => openImagePreview(img.src));
                        messageHTML += img.outerHTML;
                    });
                }

                // Add Message Details (Sent/Seen) - initially hidden
                if (!isError) {
                     messageHTML += `<div class="message-details">Sent at ${getCurrentTime()}</div>`;
                }

                messageHTML += `</div>`; // Close message div

                // Add Reactions container (empty, populated on interaction)
                if (!isError) {
                    messageHTML += `<div class="message-reactions"></div>`;
                }

                container.innerHTML = messageHTML;
                chatMessages.insertBefore(container, typingIndicatorElement); // Insert before typing indicator

                // Add event listeners after element is in DOM
                const messageElement = container.querySelector('.message');
                if (messageElement && !isError) {
                    setupMessageInteraction(messageElement);
                }

                // Scroll to bottom
                if (isScrolledToBottom || isUser) { // Always scroll for user messages
                    scrollToBottom(false);
                }

                return container;
            }

            function setupMessageInteraction(messageElement) {
                // 1. Toggle Details Panel on Click
                messageElement.addEventListener('click', (e) => {
                    // Prevent click from propagating if clicking on a link or image inside
                    if (e.target.tagName === 'A' || e.target.tagName === 'IMG') {
                        return;
                    }
                    e.stopPropagation();
                    const container = messageElement.closest('.message-container');
                    const wasOpen = container.classList.contains('show-details');

                    // Close all other detail panels
                    document.querySelectorAll('.message-container.show-details').forEach(el => {
                        if (el !== container) {
                            el.classList.remove('show-details');
                        }
                    });
                    // Toggle current panel
                    container.classList.toggle('show-details', !wasOpen);
                });

                // 2. Show Reaction Panel on Hover (Desktop) / Long Press (Mobile)
                let longPressTimer;
                let isLongPress = false;

                messageElement.addEventListener('mouseenter', () => {
                    // Optimization: Don't show panel if emoji picker is already open for this message
                    if (activeEmojiPicker && activeMessageElementForReaction === messageElement) return;
                    messageElement.classList.add('show-reactions'); // Use class to show panel via CSS
                });
                messageElement.addEventListener('mouseleave', () => {
                     // Add a small delay before hiding to allow moving cursor to panel
                    setTimeout(() => {
                        if (!messageElement.querySelector('.reaction-panel:hover') && !messageElement.querySelector('.emoji-picker:hover')) {
                             messageElement.classList.remove('show-reactions');
                        }
                    }, 100);
                });

                messageElement.addEventListener('touchstart', (e) => {
                    isLongPress = false;
                    longPressTimer = setTimeout(() => {
                        isLongPress = true;
                        showReactionPanel(messageElement);
                        // Optional: Add vibration feedback
                        if (navigator.vibrate) navigator.vibrate(50);
                    }, 500); // 500ms for long press
                }, { passive: true });

                messageElement.addEventListener('touchmove', () => {
                    clearTimeout(longPressTimer);
                });

                messageElement.addEventListener('touchend', (e) => {
                    clearTimeout(longPressTimer);
                    // If it wasn't a long press, treat as a regular click (handled above)
                    // if (!isLongPress) { ... }
                });

                // Add reaction panel dynamically if not present
                if (!messageElement.querySelector('.reaction-panel')) {
                    const reactionPanel = reactionPanelTemplate.cloneNode(true);
                    reactionPanel.id = ''; // Remove template ID
                    reactionPanel.style.display = 'flex'; // Ensure it's flex
                    messageElement.appendChild(reactionPanel);

                    // Add listeners to the cloned panel's buttons
                    reactionPanel.querySelectorAll('.reaction-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            e.stopPropagation(); // Prevent message click
                            const emoji = btn.getAttribute('data-emoji');
                            if (emoji === '+') {
                                showEmojiPickerForReaction(messageElement);
                            } else {
                                addReactionToMessage(messageElement, emoji);
                                hideReactionPanel(messageElement);
                            }
                        });
                    });

                    // Hide panel if mouse leaves it
                    reactionPanel.addEventListener('mouseleave', () => {
                         setTimeout(() => {
                            if (!messageElement.matches(':hover')) {
                                messageElement.classList.remove('show-reactions');
                            }
                        }, 100);
                    });
                }
            }

            function showReactionPanel(messageElement) {
                hideEmojiPicker(); // Hide any open emoji picker first
                activeMessageElementForReaction = messageElement;
                messageElement.classList.add('show-reactions');
                // Ensure panel exists
                if (!messageElement.querySelector('.reaction-panel')) {
                    setupMessageInteraction(messageElement); // This will add the panel
                }
            }

            function hideReactionPanel(messageElement) {
                if (messageElement) {
                    messageElement.classList.remove('show-reactions');
                }
                activeMessageElementForReaction = null;
            }

            function addReactionToMessage(messageElement, emoji) {
                const reactionsContainer = messageElement.parentElement.querySelector('.message-reactions');
                if (!reactionsContainer) return;

                let existingReaction = reactionsContainer.querySelector(`.message-reaction[data-emoji="${emoji}"]`);

                if (existingReaction) {
                    // Optional: Implement un-reacting or multiple reactions logic here
                    // For now, just animate
                    existingReaction.style.animation = 'none';
                    void existingReaction.offsetWidth; // Trigger reflow
                    existingReaction.style.animation = 'reactionAppear 0.2s ease-out';
                } else {
                    const reaction = document.createElement('button'); // Use button for accessibility
                    reaction.className = 'message-reaction';
                    reaction.setAttribute('data-emoji', emoji);
                    reaction.setAttribute('aria-label', `React with ${emoji}`);
                    reaction.innerHTML = `${emoji} <span class="reaction-count">1</span>`;
                    reactionsContainer.appendChild(reaction);

                    // Add listener to remove reaction (example)
                    reaction.addEventListener('click', (e) => {
                        e.stopPropagation();
                        reaction.remove();
                        // Optional: Send un-react event to backend
                    });
                }
                scrollToBottomIfNear(); // Adjust scroll if reactions change layout
            }

            // --- Emoji Picker Logic ---
            function initEmojiPicker(pickerElement, onEmojiSelect) {
                const categoriesContainer = pickerElement.querySelector('.emoji-categories');
                const emojiContainer = pickerElement.querySelector('.emoji-container');
                categoriesContainer.innerHTML = ''; // Clear existing

                Object.keys(emojisByCategory).forEach((categoryKey, index) => {
                    const categoryData = emojisByCategory[categoryKey];
                    const btn = document.createElement('button');
                    btn.className = 'emoji-category';
                    btn.textContent = categoryData.icon;
                    btn.setAttribute('data-category', categoryKey);
                    btn.setAttribute('aria-label', `${categoryKey} emojis`);
                    if (index === 0) btn.classList.add('active'); // Activate first category

                    btn.addEventListener('click', () => {
                        categoriesContainer.querySelectorAll('.emoji-category').forEach(el => el.classList.remove('active'));
                        btn.classList.add('active');
                        populateEmojiContainer(pickerElement, categoryKey, onEmojiSelect);
                    });
                    categoriesContainer.appendChild(btn);
                });

                // Populate initial category
                populateEmojiContainer(pickerElement, Object.keys(emojisByCategory)[0], onEmojiSelect);
            }

            function populateEmojiContainer(pickerElement, categoryKey, onEmojiSelect) {
                const emojiContainer = pickerElement.querySelector('.emoji-container');
                emojiContainer.innerHTML = ''; // Clear existing emojis
                emojiContainer.scrollTop = 0; // Scroll to top

                const emojis = emojisByCategory[categoryKey]?.emojis || [];
                emojis.forEach(emoji => {
                    const btn = document.createElement('button');
                    btn.className = 'emoji-btn';
                    btn.textContent = emoji;
                    btn.setAttribute('aria-label', `${emoji} emoji`);
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        onEmojiSelect(emoji);
                        // Optionally add to recent emojis
                        // addEmojiToRecents(emoji);
                    });
                    emojiContainer.appendChild(btn);
                });
            }

            function toggleEmojiPicker(pickerElement, triggerElement) {
                const isVisible = pickerElement.classList.contains('visible');
                hideEmojiPicker(); // Hide any other picker first
                if (!isVisible) {
                    pickerElement.classList.add('visible');
                    activeEmojiPicker = pickerElement;
                    // Position picker relative to trigger if needed (e.g., for reaction picker)
                    if (pickerElement.id === 'emoji-picker-reaction-template') {
                        // Position logic for reaction picker (already handled by CSS?)
                    }
                } else {
                    hideEmojiPicker(pickerElement);
                }
            }

            function showEmojiPickerForReaction(messageElement) {
                hideReactionPanel(messageElement);
                hideEmojiPicker(); // Hide input picker if open

                activeMessageElementForReaction = messageElement;
                const picker = emojiPickerReactionTemplate.cloneNode(true);
                picker.id = `reaction-picker-${messageElement.dataset.messageId}`;
                picker.style.display = 'flex'; // Make it flex container

                // Initialize the cloned picker
                initEmojiPicker(picker, (emoji) => {
                    addReactionToMessage(messageElement, emoji);
                    hideEmojiPicker(picker);
                });

                // Append and show
                messageElement.appendChild(picker);
                setTimeout(() => picker.classList.add('visible'), 10); // Add class for transition
                activeEmojiPicker = picker;

                 // Add listener to hide if mouse leaves picker
                picker.addEventListener('mouseleave', () => {
                    setTimeout(() => {
                        if (!messageElement.matches(':hover')) {
                            hideEmojiPicker(picker);
                        }
                    }, 300);
                });
            }

            function hideEmojiPicker(pickerToHide = null) {
                const picker = pickerToHide || activeEmojiPicker;
                if (picker && picker.classList.contains('visible')) {
                    picker.classList.remove('visible');
                    // If it's a temporary reaction picker, remove it after transition
                    if (picker.id.startsWith('reaction-picker-')) {
                        picker.addEventListener('transitionend', () => {
                            if (picker.parentNode) picker.remove();
                        }, { once: true });
                    }
                }
                if (picker === activeEmojiPicker) {
                    activeEmojiPicker = null;
                }
                activeMessageElementForReaction = null; // Clear message context too
            }

            // --- Input Area Logic ---
            function autoResizeTextarea() {
                messageInput.style.height = 'auto'; // Reset height
                let scrollHeight = messageInput.scrollHeight;
                const maxHeight = 100; // Max height in pixels
                if (scrollHeight > maxHeight) {
                    messageInput.style.height = maxHeight + 'px';
                    messageInput.style.overflowY = 'auto'; // Show scrollbar when max height reached
                } else {
                    messageInput.style.height = scrollHeight + 'px';
                    messageInput.style.overflowY = 'hidden'; // Hide scrollbar otherwise
                }
            }

            function updateInputState() {
                const hasText = messageInput.value.trim().length > 0;
                sendButton.disabled = !hasText;
            }

            function updateCharCounter() {
                const count = messageInput.value.length;
                charCounter.textContent = `${count}/${MAX_INPUT_LENGTH}`;
                charCounter.style.color = count > MAX_INPUT_LENGTH ? 'red' : 'var(--text-secondary)';
            }

            // --- Scrolling Logic ---
            function handleScroll() {
                clearTimeout(scrollDebounceTimer);
                scrollDebounceTimer = setTimeout(() => {
                    const isAtBottom = chatMessages.scrollHeight - chatMessages.scrollTop <= chatMessages.clientHeight + 50; // Threshold
                    isScrolledToBottom = isAtBottom;
                    scrollToBottomBtn.classList.toggle('visible', !isAtBottom && chatMessages.scrollHeight > chatMessages.clientHeight);
                }, 100);
            }

            function scrollToBottom(instant = false) {
                chatMessages.scrollTo({
                    top: chatMessages.scrollHeight,
                    behavior: instant ? 'instant' : 'smooth'
                });
            }

            function scrollToBottomIfNear() {
                 if (isScrolledToBottom) {
                    scrollToBottom(false);
                 }
            }

            // --- Image Handling Logic ---
            function handlePhotoSelect(event) {
                const file = event.target.files[0];
                if (file && file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        currentPhotoData = e.target.result; // Base64 string
                        photoPreviewImage.src = currentPhotoData;
                        showPhotoPreview();
                    }
                    reader.readAsDataURL(file);
                }
                photoInput.value = ''; // Reset input
            }

            function showPhotoPreview() {
                photoPreviewContainer.classList.add('visible');
                // Adjust chat padding to make space for preview
                chatApp.style.paddingBottom = `${photoPreviewContainer.offsetHeight}px`;
                scrollToBottom(true); // Scroll to keep input visible
            }

            function hidePhotoPreview() {
                photoPreviewContainer.classList.remove('visible');
                currentPhotoData = null;
                photoPreviewImage.src = '';
                chatApp.style.paddingBottom = '0px';
            }

            function handleSendPhoto() {
                if (currentPhotoData) {
                    // Add message with image placeholder (or actual image)
                    addMessageToChat("Here's the photo:", true, false, [currentPhotoData]);
                    conversationHistory.push({ role: 'user', parts: [{ text: "(User sent an image)" }] }); // Represent image in history

                    // TODO: Implement actual image upload/processing with API if needed
                    // For now, just simulate a bot response
                    setBotTyping(true);
                    setTimeout(() => {
                        setBotTyping(false);
                        const response = "Wow, nice photo!";
                        addMessageToChat(response, false);
                        conversationHistory.push({ role: 'model', parts: [{ text: response }] });
                    }, 1500);

                    hidePhotoPreview();
                }
            }

            function openImagePreview(imageSrc) {
                imagePreviewImg.src = imageSrc;
                imagePreviewModal.classList.add('visible');
            }

            function closeImagePreview() {
                imagePreviewModal.classList.remove('visible');
                imagePreviewImg.src = ''; // Clear src
            }

            // --- Initial Load ---
            init();
        });
    </script>
</body>
</html>